<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinFlow Analytics Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; color: #333; margin: 0; padding: 2rem; }
        .container { max-width: 800px; margin: auto; background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; }
        .controls { margin-bottom: 2rem; text-align: center; }
        label { font-weight: bold; margin-right: 1rem; }
        select { padding: 0.5rem; border-radius: 4px; border: 1px solid #ccc; min-width: 150px; }
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #eaf1f5; }
        .price-up { color: #27ae60; }
        .price-down { color: #c0392b; }
        .alert { font-weight: bold; color: #e67e22; }
    </style>
</head>
<body>

    <div class="container">
        <h1>FinFlow Analytics</h1>

        <div class="controls">
            <label for="stock-select">Select a Stock:</label>
            <select id="stock-select">
                <option>Loading...</option>
            </select>
        </div>

        <div id="data-display">
            </div>
    </div>

    <script>
        // Get references to the HTML elements
        const stockSelect = document.getElementById('stock-select');
        const dataDisplay = document.getElementById('data-display');

        // Function to fetch the list of stocks and populate the dropdown
        async function populateStockSelector() {
            try {
                const response = await fetch('/api/stocks');
                const tickers = await response.json();

                stockSelect.innerHTML = '<option value="">-- Select a Ticker --</option>'; // Clear loading text
                tickers.forEach(ticker => {
                    const option = document.createElement('option');
                    option.value = ticker;
                    option.textContent = ticker;
                    stockSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load stock list:', error);
                stockSelect.innerHTML = '<option>Failed to load</option>';
            }
        }

        // Function to fetch and display data for the selected stock
        async function displayStockData(ticker) {
            if (!ticker) {
                dataDisplay.innerHTML = '';
                return;
            }
            try {
                const response = await fetch(`/api/stock/${ticker}`);
                const data = await response.json();
                
                let tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Price</th>
                                <th>50-Day Avg.</th>
                                <th>Signal</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.forEach(row => {
                    const price = parseFloat(row.price);
                    const movingAverage = parseFloat(row.moving_average_50);
                    const priceClass = price >= movingAverage ? 'price-up' : 'price-down';
                    const alertSignal = price < movingAverage ? '<span class="alert">â–¼ Sell</span>' : '<span>-</span>';

                    tableHTML += `
                        <tr>
                            <td>${row.trade_date}</td>
                            <td class="${priceClass}">$${price.toFixed(2)}</td>
                            <td>$${movingAverage.toFixed(2)}</td>
                            <td>${alertSignal}</td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table>';
                dataDisplay.innerHTML = tableHTML;

            } catch (error) {
                console.error(`Failed to load data for ${ticker}:`, error);
                dataDisplay.innerHTML = `<p>Error loading data for ${ticker}.</p>`;
            }
        }

        // Event listener for the dropdown menu
        stockSelect.addEventListener('change', (event) => {
            displayStockData(event.target.value);
        });

        // Initial population of the dropdown when the page loads
        document.addEventListener('DOMContentLoaded', populateStockSelector);
    </script>
</body>
</html>